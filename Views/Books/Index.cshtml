@{
    ViewData["Title"] = "Kitaplar";
}

<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Kitap Kataloğu</h1>
        <div class="d-flex">
            <input type="search" id="searchInput" class="form-control me-2" placeholder="Kitap ara..." style="width: 300px;">
            <button class="btn btn-primary" onclick="searchBooks()">
                <i class="fas fa-search"></i> Ara
            </button>
        </div>
    </div>

    <!-- Kiralık Kitaplarım -->
    @if (Context.Session.GetInt32("UserId") != null)
    {
        <div class="card mb-4" id="myRentalsCard">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-book-reader me-2"></i>Kiralık Kitaplarım</h5>
                <span id="rentalCountBadge" class="badge bg-light text-primary">0/3</span>
            </div>
            <div class="card-body">
                <div id="myRentalsList">
                    <p class="text-muted">Yükleniyor...</p>
                </div>
            </div>
        </div>
    }

    <!-- Yükleniyor mesajı -->
    <div id="loadingMessage" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Yükleniyor...</span>
        </div>
        <p class="mt-3">Kitaplar yükleniyor...</p>
    </div>

    <!-- Kitap tablosu -->
    <div id="bookTableContainer" class="card" style="display: none;">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Kitap Adı</th>
                            <th>Yazar</th>
                            <th>Kategori</th>
                            <th>Yayınevi</th>
                            <th>ISBN</th>
                            <th>Sayfa</th>
                            <th>Durum</th>
                            <th>İşlem</th>
                        </tr>
                    </thead>
                    <tbody id="bookList">
                        <!-- Kitaplar buraya dinamik olarak eklenecek -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Hata mesajı -->
    <div id="errorMessage" class="alert alert-danger" style="display: none;" role="alert">
        Kitaplar yüklenirken bir hata oluştu. Lütfen daha sonra tekrar deneyin.
    </div>
</div>

@section Scripts {
    <script>
        // Sayfa yüklendiğinde kitapları getir
        document.addEventListener('DOMContentLoaded', function() {
            loadBooks();
            loadMyRentals();
        });

        // Kullanıcının kiralık kitaplarını yükle
        async function loadMyRentals() {
            const userId = @(Context.Session.GetInt32("UserId") ?? 0);
            
            if (userId === 0) {
                return; // Giriş yapmamış
            }

            try {
                const response = await fetch(`/api/BooksApi/rentals/user/${userId}`);
                if (!response.ok) throw new Error('API çağrısı başarısız');

                const rentals = await response.json();
                const activeRentals = rentals.filter(r => r.status === 'Active');

                // Badge güncelle
                document.getElementById('rentalCountBadge').textContent = `${activeRentals.length}/3`;

                // Liste güncelle
                const myRentalsList = document.getElementById('myRentalsList');
                
                if (activeRentals.length === 0) {
                    myRentalsList.innerHTML = '<p class="text-muted mb-0">Şu anda kiralık kitabınız bulunmamaktadır.</p>';
                    return;
                }

                myRentalsList.innerHTML = `
                    <div class="table-responsive">
                        <table class="table table-sm mb-0">
                            <thead>
                                <tr>
                                    <th>Kitap</th>
                                    <th>Yazar</th>
                                    <th>Kiralama Tarihi</th>
                                    <th>İade Tarihi</th>
                                    <th>İşlem</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${activeRentals.map(rental => `
                                    <tr>
                                        <td><strong>${rental.book.title}</strong></td>
                                        <td>${rental.book.author || '-'}</td>
                                        <td>${new Date(rental.rentalDate).toLocaleDateString('tr-TR')}</td>
                                        <td>
                                            <span class="badge ${isOverdue(rental.dueDate) ? 'bg-danger' : 'bg-warning text-dark'}">
                                                ${new Date(rental.dueDate).toLocaleDateString('tr-TR')}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-success btn-sm" onclick="returnBook(${rental.id})">
                                                <i class="fas fa-undo me-1"></i>İade Et
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                console.error('Kiralık kitaplar yüklenirken hata:', error);
            }
        }

        // Gecikme kontrolü
        function isOverdue(dueDate) {
            return new Date(dueDate) < new Date();
        }

        // Kitapları API'den yükle
        async function loadBooks(searchTerm = '') {
            const loadingMessage = document.getElementById('loadingMessage');
            const bookTableContainer = document.getElementById('bookTableContainer');
            const errorMessage = document.getElementById('errorMessage');

            try {
                // Yükleniyor göster
                loadingMessage.style.display = 'block';
                bookTableContainer.style.display = 'none';
                errorMessage.style.display = 'none';

                // API'den kitapları çek
                let url = '/api/BooksApi';
                if (searchTerm) {
                    url += `?search=${encodeURIComponent(searchTerm)}`;
                }

                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('API çağrısı başarısız oldu');
                }

                const books = await response.json();

                // Kitapları göster
                displayBooks(books);

                // Yükleniyor mesajını gizle, tabloyu göster
                loadingMessage.style.display = 'none';
                bookTableContainer.style.display = 'block';

            } catch (error) {
                console.error('Hata:', error);
                loadingMessage.style.display = 'none';
                errorMessage.style.display = 'block';
            }
        }

        // Kitapları tabloda göster
        function displayBooks(books) {
            const bookList = document.getElementById('bookList');
            
            if (books.length === 0) {
                bookList.innerHTML = '<tr><td colspan="8" class="text-center py-5"><h5>Kitap bulunamadı</h5></td></tr>';
                return;
            }

            bookList.innerHTML = books.map(book => `
                <tr>
                    <td><strong>${book.title}</strong></td>
                    <td>${book.author || '-'}</td>
                    <td>${book.category || '-'}</td>
                    <td>${book.publisher || '-'}</td>
                    <td>${book.isbn || '-'}</td>
                    <td>${book.pageCount || '-'}</td>
                    <td>
                        <span class="badge ${book.availableCopies > 0 ? 'bg-success' : 'bg-danger'}">
                            ${book.availableCopies > 0 ? `${book.availableCopies} Müsait` : 'Stokta Yok'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-primary btn-sm" 
                                onclick="rentBook(${book.id})" 
                                ${book.availableCopies <= 0 ? 'disabled' : ''}>
                            <i class="fas fa-book-reader me-1"></i>Kirala
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Arama fonksiyonu
        function searchBooks() {
            const searchTerm = document.getElementById('searchInput').value;
            loadBooks(searchTerm);
        }

        // Enter tuşu ile arama
        document.getElementById('searchInput')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchBooks();
            }
        });

        // Kitap kiralama
        async function rentBook(bookId) {
            // Session'dan kullanıcı ID'sini al
            const userId = @(Context.Session.GetInt32("UserId") ?? 0);
            
            if (userId === 0) {
                alert('Kitap kiralamak için giriş yapmalısınız.');
                window.location.href = '/Account/Login';
                return;
            }

            if (!confirm('Bu kitabı kiralamak istediğinizden emin misiniz?')) {
                return;
            }

            try {
                const response = await fetch('/api/BooksApi/rent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: userId,
                        bookId: bookId
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    alert('Kitap başarıyla kiralandı! İade tarihi: ' + result.dueDate);
                    loadBooks(); // Listeyi yenile
                    loadMyRentals(); // Kiralık kitapları yenile
                } else {
                    alert('Hata: ' + (result.message || 'Kitap kiralanamadı'));
                }
            } catch (error) {
                console.error('Hata:', error);
                alert('Kitap kiralama sırasında bir hata oluştu.');
            }
        }

        // Kitap iade etme
        async function returnBook(rentalId) {
            if (!confirm('Bu kitabı iade etmek istediğinizden emin misiniz?')) {
                return;
            }

            try {
                const response = await fetch('/api/BooksApi/return', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        rentalId: rentalId
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    alert('Kitap başarıyla iade edildi!');
                    loadBooks(); // Listeyi yenile
                    loadMyRentals(); // Kiralık kitapları yenile
                } else {
                    alert('Hata: ' + (result.message || 'Kitap iade edilemedi'));
                }
            } catch (error) {
                console.error('Hata:', error);
                alert('Kitap iade sırasında bir hata oluştu.');
            }
        }
    </script>
}
