@model IEnumerable<WEB_Library_Management_System.Models.Book>

@{
    ViewData["Title"] = "Kitap Yönetimi";
}

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-book"></i> Kitap Yönetimi</h1>
        <div>
            <button class="btn btn-success" onclick="showAddBookModal()">
                <i class="fas fa-plus"></i> Yeni Kitap Ekle
            </button>
            <a asp-action="Index" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Geri Dön
            </a>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Kitap Adı</th>
                            <th>Yazar</th>
                            <th>ISBN</th>
                            <th>Kategori</th>
                            <th>Toplam Kopya</th>
                            <th>Müsait</th>
                            <th>Durum</th>
                            <th>İşlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var book in Model)
                        {
                            <tr>
                                <td>@book.Id</td>
                                <td>
                                    <strong>@book.Title</strong><br>
                                    <small class="text-muted">@book.Publisher</small>
                                </td>
                                <td>@book.Author</td>
                                <td>@(book.ISBN ?? "-")</td>
                                <td>@(book.Category ?? "-")</td>
                                <td>@book.TotalCopies</td>
                                <td>
                                    <span class="badge @(book.AvailableCopies > 0 ? "bg-success" : "bg-danger")">
                                        @book.AvailableCopies
                                    </span>
                                </td>
                                <td>
                                    @if (book.IsAvailable)
                                    {
                                        <span class="badge bg-success">Müsait</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-danger">Stokta Yok</span>
                                    }
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="editBook(@book.Id)" title="Düzenle">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteBook(@book.Id, '@book.Title')" title="Sil">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Kitap Ekle/Düzenle Modal -->
<div class="modal fade" id="bookModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bookModalTitle">Yeni Kitap Ekle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="bookForm">
                    <input type="hidden" id="bookId">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Kitap Adı *</label>
                            <input type="text" class="form-control" id="bookTitle" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Yazar *</label>
                            <input type="text" class="form-control" id="bookAuthor" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">ISBN</label>
                            <input type="text" class="form-control" id="bookISBN">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Kategori</label>
                            <input type="text" class="form-control" id="bookCategory">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Yayınevi</label>
                            <input type="text" class="form-control" id="bookPublisher">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Yayın Tarihi</label>
                            <input type="date" class="form-control" id="bookPublishDate">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Sayfa Sayısı</label>
                            <input type="number" class="form-control" id="bookPageCount">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Toplam Kopya *</label>
                            <input type="number" class="form-control" id="bookTotalCopies" min="1" required>
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label">Açıklama</label>
                            <textarea class="form-control" id="bookDescription" rows="3"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-primary" onclick="saveBook()">Kaydet</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let bookModal;
        let isEditMode = false;

        document.addEventListener('DOMContentLoaded', function() {
            bookModal = new bootstrap.Modal(document.getElementById('bookModal'));
        });

        function showAddBookModal() {
            isEditMode = false;
            document.getElementById('bookModalTitle').textContent = 'Yeni Kitap Ekle';
            document.getElementById('bookForm').reset();
            document.getElementById('bookId').value = '';
            bookModal.show();
        }

        async function editBook(id) {
            isEditMode = true;
            document.getElementById('bookModalTitle').textContent = 'Kitap Düzenle';
            
            try {
                const response = await fetch(`/api/AdminApi/get-book/${id}`);
                if (!response.ok) throw new Error('Kitap bilgileri alınamadı');

                const book = await response.json();

                // Form alanlarını doldur
                document.getElementById('bookId').value = book.id;
                document.getElementById('bookTitle').value = book.title;
                document.getElementById('bookAuthor').value = book.author;
                document.getElementById('bookISBN').value = book.isbn || '';
                document.getElementById('bookCategory').value = book.category || '';
                document.getElementById('bookPublisher').value = book.publisher || '';
                document.getElementById('bookPublishDate').value = book.publishDate || '';
                document.getElementById('bookPageCount').value = book.pageCount || '';
                document.getElementById('bookTotalCopies').value = book.totalCopies;
                document.getElementById('bookDescription').value = book.description || '';

                bookModal.show();
            } catch (error) {
                console.error('Hata:', error);
                alert('Kitap bilgileri yüklenirken bir hata oluştu.');
            }
        }

        async function deleteBook(id, title) {
            if (!confirm(`"${title}" kitabını silmek istediğinizden emin misiniz? Bu işlem geri alınamaz!`)) {
                return;
            }

            try {
                const response = await fetch(`/api/AdminApi/delete-book/${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    alert(result.message);
                    location.reload();
                } else {
                    alert('Hata: ' + (result.message || 'Kitap silinemedi'));
                }
            } catch (error) {
                console.error('Hata:', error);
                alert('Silme işlemi sırasında bir hata oluştu.');
            }
        }

        async function saveBook() {
            const bookId = document.getElementById('bookId').value;
            
            // PageCount değerini integer'a çevir
            const pageCountValue = document.getElementById('bookPageCount').value;
            const pageCount = pageCountValue ? parseInt(pageCountValue) : null;
            
            const bookData = {
                Title: document.getElementById('bookTitle').value,
                Author: document.getElementById('bookAuthor').value,
                ISBN: document.getElementById('bookISBN').value || null,
                Category: document.getElementById('bookCategory').value || null,
                Publisher: document.getElementById('bookPublisher').value || null,
                PublishDate: document.getElementById('bookPublishDate').value || null,
                PageCount: pageCount,
                TotalCopies: parseInt(document.getElementById('bookTotalCopies').value),
                Description: document.getElementById('bookDescription').value || null
            };

            // Form validasyonu
            if (!bookData.Title || !bookData.Author || !bookData.TotalCopies) {
                alert('Lütfen zorunlu alanları doldurun (Kitap Adı, Yazar, Toplam Kopya).');
                return;
            }

            if (bookData.TotalCopies < 1) {
                alert('Toplam kopya sayısı en az 1 olmalıdır.');
                return;
            }

            try {
                let response;
                if (isEditMode && bookId) {
                    // Güncelleme
                    console.log('Güncelleme yapılıyor. BookId:', bookId);
                    console.log('Gönderilen veri:', bookData);
                    response = await fetch(`/api/AdminApi/update-book/${bookId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(bookData)
                    });
                } else {
                    // Yeni ekleme
                    console.log('Yeni kitap ekleniyor');
                    console.log('Gönderilen veri:', bookData);
                    response = await fetch('/api/AdminApi/add-book', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(bookData)
                    });
                }

                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Response data:', result);

                if (response.ok) {
                    alert(result.message);
                    bookModal.hide();
                    location.reload();
                } else {
                    alert('Hata: ' + (result.message || 'İşlem başarısız oldu'));
                }
            } catch (error) {
                console.error('Hata detayı:', error);
                alert('İşlem sırasında bir hata oluştu: ' + error.message);
            }
        }
    </script>
}
